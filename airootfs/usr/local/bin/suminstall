#!/bin/bash

source /usr/local/bin/install/config
source /usr/local/bin/install/packer


# PREPARING
if [[ ! -z $(findmnt --mountpoint /mnt) ]]; then 
 	umount -R /mnt
fi


# LUKSFORMAT
if [[ ! -e /dev/mapper/proc ]]; then 
	cryptsetup luksOpen $DISKPROC proc
fi

if [[ ! -e /dev/mapper/data  ]]; then 
	cryptsetup luksOpen $DISKDATA data
fi


# DISKMOUNT
mkfs.ext4 -F -b 4096 /dev/mapper/proc &&
mount /dev/mapper/proc /mnt &&
echo "partition proc is mounted"

mkdir -p /mnt/boot &&
mkfs.vfat -F32 -S 4096 -n BOOT $DISKBOOT &&
mount -o uid=0,gid=0,dmask=007,fmask=007 $DISKBOOT /mnt/boot/ &&
echo "partition boot is mounted"

mkdir -p /mnt/home &&
mkfs.ext4 -F -b 4096 /dev/mapper/data &&
mount /dev/mapper/data /mnt/home &&
echo "partition home is mounted"


# PROCESSOR
procieidven=$(grep "vendor_id" /proc/cpuinfo | head -n 1 | awk '{print $3}')

if [[ "$procieidven" == "GenuineIntel" ]]; then
    pacstrap /mnt intel-ucode $DISTRO_INSTALLATION_PACKAGE &&
    echo "base package installed"
elif [[ "$procieidven" == "AuthenticAMD" ]]; then
    pacstrap /mnt amd-ucode $DISTRO_INSTALLATION_PACKAGE &&
    echo "base package installed"
fi


# GRAPHICAL
graphidven=$(lspci | grep -i --color 'vga\')

if [[ ! -z $(echo $graphidven | grep -i --color 'Intel Corporation') ]];then
    pacstrap /mnt vulkan-intel &&
    echo "radeon graphic installed"
fi

if [[ ! -z $(lspci | grep -i --color '3d\|NVIDIA') ]];then
    echo "graphic nvidia"
fi

if [[ ! -z $(lspci | grep -i --color '3d\|RADEON') ]];then
    pacstrap /mnt vulkan-radeon &&
    echo "radeon graphic installed"
fi


# POSTCONFIG
genfstab -U /mnt > /mnt/etc/fstab &&
cp -fr /usr/local/bin/install/ /mnt/post &&


# ARCHCHROOT
arch-chroot /mnt /bin/bash /post/init.sh &&
rm -fr /mnt/post &&